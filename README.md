# Mini CRM Backend

Асинхронный FastAPI‑бэкенд, предоставляющий мультиарендную мини‑CRM с организациями, пользователями/ролями, контактами, сделками, задачами, активностями и аналитикой.

## Возможности
- JWT‑аутентификация (регистрация/логин) с парой access/refresh токенов.
- Жёсткая привязка ко входящей организации через заголовок `X-Organization-Id` и ролевую модель (owner/admin/manager/member).
- Бизнес‑правила: запрет выигрыша сделки без суммы, ограничения на откат стадий, автоматические записи в таймлайн, проверки владельца задач и дедлайнов.
- Аналитика сделок (summary + funnel) с простым TTL‑кэшем в памяти.
- Чёткое разделение на уровни api/services/repositories/models, async SQLAlchemy + Alembic.
- Типизированный код и подготовленные инструменты качества (`mypy`, `ruff`, `pytest`).

## Быстрый старт
1. **Установка зависимостей**
   ```bash
   pip install -e .[dev]
   ```
2. **Настройка окружения**  
   Скопируйте `.env.example` в `.env`, задайте секреты и `DATABASE_URL`. Приложение рассчитано на PostgreSQL (драйвер asyncpg).
3. **Миграции БД**
   ```bash
   alembic upgrade head
   ```
4. **Запуск API**
   ```bash
   uvicorn app.main:app --reload
   ```

Документация OpenAPI находится по адресу `http://localhost:8000/docs`.

## Аутентификация и контекст организации
- Токены выдаются через `/api/v1/auth/register` или `/api/v1/auth/login`.
- Все защищённые запросы требуют заголовка `Authorization: Bearer <access_token>`.
- Для выбора рабочей организации добавляйте `X-Organization-Id: <org_id>`. Список организаций и ролей — `GET /api/v1/organizations/me`.

## Тесты и линтеры
- Юнит‑ и интеграционные тесты (SQLite + aiosqlite):
  ```bash
  pytest
  ```
- Статический анализ:
  ```bash
  ruff check .
  mypy app
  ```

## Структура проекта
```
app/
  api/routers        # роутеры FastAPI
  api/dependencies   # общие зависимости (аутентификация/организация)
  core               # конфигурация и безопасность
  services           # бизнес-логика
  repositories       # слой доступа к БД
  models             # ORM-модели и enum'ы
  schemas            # pydantic-схемы
  caching            # простой TTL-кэш
  db                 # фабрика AsyncSession
alembic/             # скрипты миграций
tests/               # unit + e2e тесты API
```

## Дополнительно
- Пагинация по умолчанию: `page_size=20` (`max_page_size=100`), управляется query‑параметрами.
- У `POST /contacts` и `POST /deals` есть опциональный `owner_id`, но назначать других пользователей могут только owner/admin/manager.
- Таймлайн активностей пополняется сервисами автоматически при смене статуса/стадии и создании задач; вручную разрешены только комментарии.
